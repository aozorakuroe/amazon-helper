<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>画像からCSV作成（単一画像）</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;       /* 横方向中央 */
      justify-content: center;   /* 縦方向中央 */
      text-align: center;
    }
    input, button, a {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    pre {
      background-color: #f0f0f0;
      padding: 10px;
      width: 80%;
      overflow-x: auto;
      text-align: left;
    }
  </style>
</head>
<body>
  <h2>画像からCSV作成（単一画像）</h2>

  <input type="file" id="imageFile" accept="image/*">
  <button id="readImageBtn">画像読み取り & CSV作成</button>
  <br>
  <a id="downloadLink" style="display:none;">CSVをダウンロード</a>
  <pre id="log"></pre>

  <script>
    const price = 100;
    const condition = "中古可";
    const shipping = "本の配送方法";

    document.getElementById('readImageBtn').addEventListener('click', () => {
      const file = document.getElementById('imageFile').files[0];
      if(!file){ alert("画像を選択してください"); return; }

      const reader = new FileReader();
      reader.onload = function(e){
        const img = new Image();
        img.src = e.target.result;
        img.onload = function(){
          Quagga.decodeSingle({
            src: img.src,
            numOfWorkers:0,
            inputStream: {size:800},
            decoder: {readers:["ean_reader"]}
          }, function(result){
            if(result && result.codeResult){
              const jan = result.codeResult.code;
              document.getElementById('log').textContent = `読み取ったJANコード: ${jan}\n`;

              // CSV作成（BOM付きUTF-8で文字化け対策）
              let csvContent = "JANコード,価格,コンディション,発送方法\n";
              csvContent += `${jan},${price},${condition},${shipping}\n`;

              const blob = new Blob(["\uFEFF" + csvContent], {type: "text/csv;charset=utf-8"});
              const url = URL.createObjectURL(blob);
              const link = document.getElementById("downloadLink");
              link.href = url;
              link.download = "amazon_list.csv";
              link.style.display = "inline";
              link.textContent = "CSVをダウンロード";
            } else {
              alert("バーコードが読み取れませんでした");
            }
          });
        }
      };
      reader.readAsDataURL(file);
    });
  </script>
</body>
</html>
